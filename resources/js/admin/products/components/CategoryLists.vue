<template>
  <section :data-component="slug">
    <!-- search -->
    <v-card flat>
      <div class="d-flex flex-row">
        <div class="flex-grow-1">
          <v-text-field prepend-icon="search" label="Filter By Name" v-model="filters.name"></v-text-field>
        </div>
        <div class="flex-grow-1 text-right">
          <v-btn
            icon
            color="primary"
            aria-label="Add a Category"
            @click="showDialog('category_add')"
          >
            <v-icon>mdi-plus</v-icon>
          </v-btn>
        </div>
      </div>
    </v-card>
    <!-- /search -->

    <!-- categorys table -->
    <v-data-table
      v-bind:headers="headers"
      :options.sync="pagination"
      :items="items"
      :item-key="items.name"
      :server-items-length="totalItems"
    >
      <template v-slot:item="{ item }">
        <tr>
          <td>
            <a
              @click="$router.push({name: 'category.edit', params: {id: item.id}})"
              title="Edit Category"
            >{{ item.name }}</a>
          </td>
          <td>
            <p>{{ item.description }}</p>
          </td>
          <td class="align-center">
            <v-chip>{{ item.product_count }}</v-chip>
          </td>
          <td>
            <timeago :datetime="item.created_at"></timeago>
          </td>
          <td class="align-right">
            <v-btn @click="showDialog('category_edit', item)" tile small>
              <v-icon class="blue--text">edit</v-icon>
            </v-btn>
            <!--
                  <v-btn @click="trash(props.item)" icon small>
                     <v-icon class="red--text">delete</v-icon>
                  </v-btn>
            -->
          </td>
        </tr>
      </template>
    </v-data-table>

    <!-- add category -->
    <v-dialog
      v-model="dialogs.add.show"
      fullscreen
      transition="dialog-bottom-transition"
      :overlay="false"
    >
      <v-card>
        <v-toolbar class="primary">
          <v-btn icon @click.native="dialogs.add.show = false">
            <v-icon>close</v-icon>
          </v-btn>
          <v-toolbar-title>Create New Category</v-toolbar-title>
          <v-spacer></v-spacer>
          <v-toolbar-items>
            <v-btn text @click.native="dialogs.add.show = false">Done</v-btn>
          </v-toolbar-items>
        </v-toolbar>
        <v-card-text>
          <category-add></category-add>
        </v-card-text>
      </v-card>
    </v-dialog>

    <!-- edit category -->
    <v-dialog
      v-model="dialogs.edit.show"
      fullscreen
      :laze="false"
      transition="dialog-bottom-transition"
      :overlay="false"
    >
      <v-card>
        <v-toolbar class="primary">
          <v-btn icon @click.native="dialogs.edit.show = false">
            <v-icon>close</v-icon>
          </v-btn>
          <v-toolbar-title>Edit Category</v-toolbar-title>
          <v-spacer></v-spacer>
          <v-toolbar-items>
            <v-btn text @click.native="dialogs.edit.show = false">Done</v-btn>
          </v-toolbar-items>
        </v-toolbar>
        <v-card-text>
          <category-edit :propCategoryId="dialogs.edit.category.id"></category-edit>
        </v-card-text>
      </v-card>
    </v-dialog>
  </section>
</template>

<script>
import CategoryAdd from "./CategoryAdd.vue";
import CategoryEdit from "./CategoryEdit.vue";

export default {
  components: {
    CategoryAdd,
    CategoryEdit
  },
  data: () => ({
    page_name: "Categories",
    headers: [
      {
        text: "Name",
        value: "name",
        align: "start",
        sortable: false
      },
      {
        text: "Description",
        value: "description"
      },
      {
        text: "Total Products",
        value: "product_count",
        align: "center"
      },
      {
        text: "Date Created",
        value: "created_at"
      },
      {
        text: null,
        value: "controls"
      }
    ],
    items: [],
    totalItems: 0,
    pagination: {
      rowsPerPage: 10
    },
    filters: {
      name: ""
    },
    dialogs: {
      edit: {
        category: {},
        show: false
      },
      add: {
        show: false
      }
    }
  }),
  mounted() {
    const self = this;
    self.$store.commit("setBreadcrumbs", [
      { label: "Products", to: { name: "product.lists" } },
      { label: "Categories", name: "" }
    ]);
    self.$eventBus.$on(
      ["CATEGORY_ADDED", "CATEGORY_UPDATED", "CATEGORY_DELETED"],
      () => self.loadCategories(() => {})
    );
  },
  watch: {
    "filters.name": _.debounce(function(v) {
      this.loadCategories(() => {});
    }, 500),
    "pagination.page": function() {
      this.loadCategories(() => {});
    },
    "pagination.rowsPerPage": function() {
      this.loadCategories(() => {});
    }
  },
  methods: {
    trash(category) {
      const self = this;

      self.$store.commit("showDialog", {
        type: "confirm",
        title: "Confirm Deletion",
        message: "Are you sure you want to delete this category?",
        okCb: () => {
          axios
            .delete("/admin/categories/" + category.id)
            .then(function(response) {
              self.$store.commit("showSnackbar", {
                message: response.data.message,
                color: "success",
                duration: 3000
              });

              self.$eventBus.$emit("CATEGORY_DELETED");
            })
            .catch(function(error) {
              if (error.response) {
                self.$store.commit("showSnackbar", {
                  message: error.response.data.message,
                  color: "error",
                  duration: 3000
                });
              } else if (error.request) {
                console.log(error.request);
              } else {
                console.log("Error", error.message);
              }
            });
        },
        cancelCb: () => {
          console.info("CANCEL");
        }
      });
    },
    showDialog(dialog, data) {
      const self = this;
      switch (dialog) {
        case "edit":
          self.dialogs.edit.category = data;
          setTimeout(() => {
            self.dialogs.edit.show = true;
          }, 500);
          break;
        case "add":
          setTimeout(() => {
            self.dialogs.add.show = true;
          }, 500);
          break;
      }
    },
    loadCategories(cb) {
      const self = this;

      let params = {
        name: self.filters.name,
        page: self.pagination.page,
        per_page: self.pagination.rowsPerPage
      };

      axios
        .get("/admin/categories", { params: params })
        .then(function(response) {
          console.dir(response);
          self.items = response.data.data.data;
          self.totalItems = response.data.data.total;
          self.pagination.totalItems = response.data.data.total;
          (cb || Function)();
        });
    }
  }
};
</script>

<style scoped>
/* span.btn { width: 2.25rem; } */
</style>
